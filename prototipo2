#include <math.h>

#define velocidade 100
#define bomba 2
#define SERVO_PIN 13

//motor lado direito
const int enA = 10;
const int in1 = 9;
const int in2 = 8;
//motor lado esquerdo
const int enB = 5;
const int in3 = 7;
const int in4 = 6;

int patrulha = 0;

//sensores
int sensor_F = A1;
int sensor_E = A2;
int sensor_D = A0;

int vetor_F[3]; 
int vetor_E[3]; 
int vetor_D[3]; 

int result_F;
int result_E;
int result_D;

void setup() {
  Serial.begin(9600);

  pinMode(enA, OUTPUT);
  pinMode(enB, OUTPUT);
  pinMode(in1, OUTPUT);
  pinMode(in2, OUTPUT);
  pinMode(in3, OUTPUT);
  pinMode(in4, OUTPUT);

  analogWrite(enA, velocidade);
  analogWrite(enB, velocidade);

  parar(); // começa parado

  pinMode(sensor_F, INPUT);
  pinMode(sensor_E, INPUT);
  pinMode(sensor_D, INPUT);
  pinMode(SERVO_PIN, OUTPUT);
  pinMode(bomba, OUTPUT);

  // corrigido (position não existe no setup)
  servoPulse(SERVO_PIN, 0);
}

void loop() {
  // 3 leituras
  for (int i = 0; i < 3; i++) { 
    vetor_F[i] = analogRead(sensor_F);
    vetor_E[i] = analogRead(sensor_E);
    vetor_D[i] = analogRead(sensor_D);
  }

  // médias
  result_F = media(vetor_F[0], vetor_F[1], vetor_F[2]);
  result_E = media(vetor_E[0], vetor_E[1], vetor_E[2]);
  result_D = media(vetor_D[0], vetor_D[1], vetor_D[2]);

  // detectar qual é o mais forte (menor valor)
  int menor = min(result_F, min(result_E, result_D));

  Serial.print("F: "); Serial.print(result_F);
  Serial.print("  E: "); Serial.print(result_E);
  Serial.print("  D: "); Serial.println(result_D);

  // fogo muito perto → apagar
  if (result_F < 180) {
    parar();
    servo();
    return;
  }

  // se o fogo está mais forte na frente
  if (menor == result_F) {
    mov_fnt();
    Serial.println("indo em direção ao fogo (frente)");
  }
  // se o fogo está mais forte à esquerda
  else if (menor == result_E) {
    manobra_E();
    Serial.println("virando para esquerda");
  }
  // se o fogo está mais forte à direita
  else if (menor == result_D) {
    manobra_D();
    Serial.println("virando para direita");
  }
  else {
    parar();
    Serial.println("nenhum fogo detectado");
  }
}


void servoPulse(int pin, int angle) {
  int pwm = (angle * 11) + 500;
  digitalWrite(pin, HIGH);
  delayMicroseconds(pwm);
  digitalWrite(pin, LOW);
  delay(20);
}

//arrumado
void servo() {

  int position;
  
  digitalWrite(bomba, HIGH); 

  for (position = 0; position <= 120; position++) {
    servoPulse(SERVO_PIN, position); 
  }

  for (position = 120; position >= 0; position--) {
    servoPulse(SERVO_PIN, position);
    result_F = analogRead(sensor_F);
  }

  digitalWrite(bomba, LOW);
}

//Movimentos
void mov_fnt(){
  digitalWrite(in1, HIGH);
  digitalWrite(in2, LOW);
  digitalWrite(in3, LOW);
  digitalWrite(in4, HIGH);
}
void mov_tras(){
  digitalWrite(in1, LOW);
  digitalWrite(in2, HIGH);
  digitalWrite(in3, HIGH);
  digitalWrite(in4, LOW);
}
void mov_dir(){
  digitalWrite(in1, LOW);
  digitalWrite(in2, HIGH);
  digitalWrite(in3, LOW);
  digitalWrite(in4, HIGH);
}
void mov_esq(){
  digitalWrite(in1, HIGH);
  digitalWrite(in2, LOW);
  digitalWrite(in3, HIGH);
  digitalWrite(in4, LOW);
}
void parar(){
  digitalWrite(in1, LOW);
  digitalWrite(in2, LOW);
  digitalWrite(in3, LOW);
  digitalWrite(in4, LOW);
}

void manobra_D() {
  mov_tras();
  delay(500);

  parar();
  delay(300);

  mov_dir();
  delay(200);

  mov_fnt();
  delay(1000);

  parar();
}

void manobra_E() {
  mov_tras();
  delay(500);

  parar();
  delay(300);

  mov_esq();
  delay(200);

  mov_fnt();
  delay(1000);

  parar();
}

// Função média adicionada
int media(int a, int b, int c) {
  return (a + b + c) / 3;
}
