#include <math.h>

//motor lado direito
const int enA = 10;
const int in1 = 9;
const int in2 = 8;
//motor lado esquerdo
const int enB = 5;
const int in3 = 7;
const int in4 = 6;

int velocidade = 160;

int patrulha = 0;

//sensores
int sensor_F = A1;
int sensor_E = A2;
int sensor_D = A0;

int vetor_F[3]; 
int vetor_E[3]; 
int vetor_D[3]; 

int result_F;
int result_E;
int result_D;

#define bomba A5
#define SERVO_PIN A4
int position;

#define LED_VERMELHO 12
#define LED_VERDE 13

void setup() {
  Serial.begin(9600);

  pinMode(enA, OUTPUT);
  pinMode(enB, OUTPUT);
  pinMode(in1, OUTPUT);
  pinMode(in2, OUTPUT);
  pinMode(in3, OUTPUT);
  pinMode(in4, OUTPUT);

  analogWrite(enA, velocidade);
  analogWrite(enB, velocidade);

  parar(); // começa parado

  pinMode(sensor_F, INPUT);
  pinMode(sensor_E, INPUT);
  pinMode(sensor_D, INPUT);

  pinMode(SERVO_PIN, OUTPUT);
  servoPulse(SERVO_PIN, position);

  pinMode(bomba, OUTPUT);

  pinMode(LED_VERMELHO, OUTPUT);
  pinMode(LED_VERDE, OUTPUT);

  digitalWrite(LED_VERMELHO, LOW);
  digitalWrite(LED_VERDE, HIGH);
}

void loop() {
  // faz 3 leituras do sensor
  for (int i = 0; i < 3; i++) { 
    vetor_F[i] = analogRead(sensor_F);
    vetor_E[i] = analogRead(sensor_E);
    vetor_D[i] = analogRead(sensor_D);
  }
 
  // calcula a média das leituras
  result_F = media(vetor_F[0],  vetor_F[1],  vetor_F[2]);
  result_E = media(vetor_E[0], vetor_E[1], vetor_E[2]);
  result_D = media(vetor_D[0], vetor_D[1], vetor_D[2]);

  // analisa o resultado
  if (result_F <= 200) {
    parar();
    servo();
    digitalWrite(bomba, 0);
    Serial.println("fogo bem perto...");
    digitalWrite(LED_VERMELHO, HIGH);
    digitalWrite(LED_VERDE, LOW);
  }

  else if (result_F >= 201 && result_F <= 800) {
    mov_fnt();
    digitalWrite(bomba, 0);
    Serial.println("fogo longe...");
    digitalWrite(LED_VERMELHO, HIGH);
    digitalWrite(LED_VERDE, LOW);
  }

  else if ( result_E < 700){
    manobra_E();
    digitalWrite(bomba, 0);
    Serial.println("virando para esquerda");\
    digitalWrite(LED_VERMELHO, HIGH);
    digitalWrite(LED_VERDE, LOW);
  }

  else if (result_D < 700){
    manobra_D();
    digitalWrite(bomba, 0);
    Serial.println("virando para direita");
    digitalWrite(LED_VERMELHO, HIGH);
    digitalWrite(LED_VERDE, LOW);
  }
  else{
    mov_tras();
    parar();
    digitalWrite(bomba, 0);
    Serial.println("nenhum fogo detectado");
    digitalWrite(LED_VERMELHO, LOW);
    digitalWrite(LED_VERDE, HIGH);
  }
  
  delay(300);
}

// função para calcular média
int media(int a, int b, int c) {
  int resultado = (a + b + c) / 3;
  return resultado;
}

void servoPulse(int pin, int angle) {
  int pwm = (angle * 11) + 500;
  digitalWrite(pin, HIGH);
  delayMicroseconds(pwm);
  digitalWrite(pin, LOW);
  delay(20);
}

void servo() {
  int position;
  digitalWrite(bomba, 1); 

  // Gira o servo da posição 0 até 120 graus
  for (position = 0; position <= 120; position++) {
    servoPulse(SERVO_PIN, position);
    result_F = analogRead(sensor_F);
    if (result_F >= 201) {
      digitalWrite(bomba, 0); 
      return;
    }
  }

  // Volta o servo de 120 até 0 graus
  for (position = 120; position >= 0; position--) {
    servoPulse(SERVO_PIN, position);
    result_F = analogRead(sensor_F);
    if (result_F > 200) {
      digitalWrite(bomba, 0);
      return;
    }
  }

  result_F = analogRead(sensor_F);
  if (result_F >= 201) {
    digitalWrite(bomba, LOW);
  } else {
    digitalWrite(bomba, HIGH); 
  }
}

//Movimentos
void mov_fnt(){
  digitalWrite(in1, HIGH);
  digitalWrite(in2, LOW);
  digitalWrite(in3, LOW);
  digitalWrite(in4, HIGH);
}
void mov_tras(){
  digitalWrite(in1, LOW);
  digitalWrite(in2, HIGH);
  digitalWrite(in3, HIGH);
  digitalWrite(in4, LOW);
}
void mov_dir(){
  digitalWrite(in1, LOW);
  digitalWrite(in2, HIGH);
  digitalWrite(in3, LOW);
  digitalWrite(in4, HIGH);
}
void mov_esq(){
  digitalWrite(in1, HIGH);
  digitalWrite(in2, LOW);
  digitalWrite(in3, HIGH);
  digitalWrite(in4, LOW);
}
void parar(){
  digitalWrite(in1, LOW);
  digitalWrite(in2, LOW);
  digitalWrite(in3, LOW);
  digitalWrite(in4, LOW);
}

void manobra_D() {
  mov_tras();
  delay(500);

  parar();
  delay(300);

  mov_dir();
  delay(200);

  mov_fnt();
  delay(1000);

  parar();
}

void manobra_E() {
  mov_tras();
  delay(500);

  parar();
  delay(300);

  mov_esq();
  delay(200);

  mov_fnt();
  delay(1000);

  parar();
}
